import { Meta, Story, Controls, Canvas, ArgTypes } from '@storybook/blocks';
import * as PopoverStories from './Popover.stories';
import { Popover, PopoverRoot, PopoverTrigger, PopoverContent, PopoverArrow, PopoverClose } from './Popover';
import { Button } from '../Button/Button';

<Meta of={PopoverStories} />

# Popover Component

The Popover component displays floating content that appears when a user interacts with a trigger element.

## Overview

Popovers are used to display additional information or actions related to an element on the page without navigating away from the current context. They're commonly used for tooltips, dropdowns, menus, and other contextual information displays.

## Import

```jsx
import { Popover } from '@tagaddod/react';
```

For advanced usage with more control over the composition:

```jsx
import { 
  PopoverRoot, 
  PopoverTrigger, 
  PopoverContent, 
  PopoverArrow, 
  PopoverClose 
} from '@tagaddod/react';
```

## Props

<ArgTypes of={Popover} />

## Basic Usage

<Canvas of={PopoverStories.Default} />

```jsx
import { Popover, Button } from '@tagaddod/react';

<Popover
  content="This is a basic popover content"
  side="bottom"
  align="center"
  showArrow={true}
>
  <Button>Click me</Button>
</Popover>
```

## Types

### Default

<Canvas of={PopoverStories.Default} />

```jsx
<Popover
  content="This is a basic popover content"
  type="default"
>
  <Button>Default Popover</Button>
</Popover>
```

### With Scrollbar

For popover content that might exceed the maximum height, use the `with-scrollbar` type to display a scrollbar.

<Canvas of={PopoverStories.WithScrollbar} />

```jsx
<Popover
  content={
    <div>
      <p>This popover has a lot of content that might require scrolling.</p>
      <p>You can see how the scrollbar appears when the content exceeds the maximum height.</p>
      <p>This is useful for displaying larger amounts of information without taking up too much screen space.</p>
      <p>The popover will automatically handle overflow content.</p>
      <p>This is line 5 of the content.</p>
      <p>This is line 6 of the content.</p>
      <p>This is line 7 of the content.</p>
      <p>This is line 8 of the content.</p>
    </div>
  }
  type="with-scrollbar"
>
  <Button>Scrollable Popover</Button>
</Popover>
```

## Positions

You can position the popover relative to the trigger using the `side` and `align` props.

<Canvas of={PopoverStories.Different_Positions} />

```jsx
// Top position
<Popover
  content="This popover appears on top"
  side="top"
  align="center"
>
  <Button>Top</Button>
</Popover>

// Right position
<Popover
  content="This popover appears on the right"
  side="right"
  align="center"
>
  <Button>Right</Button>
</Popover>

// Bottom position
<Popover
  content="This popover appears on the bottom"
  side="bottom"
  align="center"
>
  <Button>Bottom</Button>
</Popover>

// Left position
<Popover
  content="This popover appears on the left"
  side="left"
  align="center"
>
  <Button>Left</Button>
</Popover>
```

## Arrow

You can show or hide the arrow pointing to the trigger using the `showArrow` prop.

```jsx
// With arrow
<Popover
  content="This popover has an arrow"
  showArrow={true}
>
  <Button>With Arrow</Button>
</Popover>

// Without arrow
<Popover
  content="This popover has no arrow"
  showArrow={false}
>
  <Button>Without Arrow</Button>
</Popover>
```

## Animation

The popover has a default animation duration of 200ms. You can customize this with the `animationDuration` prop.

```jsx
// Faster animation
<Popover
  content="This popover animates quickly"
  animationDuration={100}
>
  <Button>Fast Animation</Button>
</Popover>

// Slower animation
<Popover
  content="This popover animates slowly"
  animationDuration={400}
>
  <Button>Slow Animation</Button>
</Popover>
```

## Advanced Composition

For more complex scenarios, you can use the individual popover components to create custom compositions.

<Canvas of={PopoverStories.Compositions} />

```jsx
import { 
  PopoverRoot, 
  PopoverTrigger, 
  PopoverContent, 
  PopoverArrow, 
  PopoverClose, 
  Button 
} from '@tagaddod/react';

// With buttons
<Popover
  content={
    <div>
      <h4 style={{ margin: '0 0 0.5rem' }}>Popover Title</h4>
      <p style={{ margin: '0 0 1rem' }}>This popover contains a title and action buttons.</p>
      <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '0.5rem' }}>
        <PopoverClose asChild>
          <Button variant="secondary" size="micro">Cancel</Button>
        </PopoverClose>
        <PopoverClose asChild>
          <Button size="micro">Confirm</Button>
        </PopoverClose>
      </div>
    </div>
  }
>
  <Button>With Buttons</Button>
</Popover>

// Custom composition
<PopoverRoot>
  <PopoverTrigger asChild>
    <Button>Custom Composition</Button>
  </PopoverTrigger>
  <PopoverContent sideOffset={5}>
    <div style={{ padding: '0.5rem' }}>
      <h4>Custom Components</h4>
      <p>Using PopoverRoot, PopoverTrigger, and PopoverContent for more control.</p>
      <PopoverArrow />
    </div>
  </PopoverContent>
</PopoverRoot>
```

## Listbox Integration

The Popover component now includes powerful listbox integration for creating dropdown menus with rich customization options.

### Basic Listbox

<Canvas of={PopoverStories.WithListbox} />

```jsx
<Popover
  useListbox
  listboxOptions={[
    { label: 'Option 1', value: '1' },
    { label: 'Option 2', value: '2' },
    { label: 'Option 3', value: '3' },
    { label: 'Option 4', value: '4' },
    { label: 'Option 5', value: '5' },
  ]}
  onListboxSelect={(value) => console.log('Selected:', value)}
>
  <Button>Select Option</Button>
</Popover>
```

### Listbox with Icons

<Canvas of={PopoverStories.WithListboxIcons} />

```jsx
<Popover
  useListbox
  listboxShowIcons
  listboxDefaultIcon="üìÑ"
  listboxOptions={[
    { label: 'Documents', value: 'docs' },
    { label: 'Images', value: 'images', icon: 'üñºÔ∏è' },
    { label: 'Videos', value: 'videos', icon: 'üé•' },
    { label: 'Music', value: 'music', icon: 'üéµ' },
    { label: 'Downloads', value: 'downloads' },
  ]}
  onListboxSelect={(value) => console.log('Selected:', value)}
>
  <Button>File Types</Button>
</Popover>
```

### Mixed Icon Configuration

<Canvas of={PopoverStories.WithMixedIcons} />

```jsx
<Popover
  useListbox
  listboxShowIcons={false} // Global setting is off
  listboxOptions={[
    { label: 'Home', value: 'home', showIcon: true, icon: 'üè†' },
    { label: 'Profile', value: 'profile' }, // No icon
    { label: 'Settings', value: 'settings', showIcon: true, icon: '‚öôÔ∏è' },
    { label: 'Help', value: 'help' }, // No icon
    { label: 'Logout', value: 'logout', showIcon: true, icon: 'üö™' },
  ]}
  onListboxSelect={(value) => console.log('Selected:', value)}
>
  <Button>Navigation</Button>
</Popover>
```

### Scrollable Listbox

<Canvas of={PopoverStories.WithScrollableListbox} />

```jsx
<Popover
  useListbox
  type="with-scrollbar"
  listboxOptions={Array.from({ length: 15 }, (_, i) => ({
    label: `Option ${i + 1}`,
    value: `option-${i + 1}`,
    helpText: i % 3 === 0 ? `This is help text for option ${i + 1}` : undefined,
  }))}
  listboxMaxItems={6}
  onListboxSelect={(value) => console.log('Selected:', value)}
>
  <Button>Long List</Button>
</Popover>
```

### Enhanced Scrollable Dropdown

<Canvas of={PopoverStories.EnhancedScrollableDropdown} />

```jsx
<Popover
  useListbox
  type="with-scrollbar"
  listboxShowIcons
  listboxMaxItems={8}
  margin="small"
  listboxOptions={[
    // Recent Files Section
    { label: 'Document.pdf', value: 'doc1', icon: 'üìÑ', helpText: 'Modified 2 hours ago' },
    { label: 'Presentation.pptx', value: 'pres1', icon: 'üìä', helpText: 'Modified 1 day ago' },
    { label: 'Spreadsheet.xlsx', value: 'sheet1', icon: 'üìà', helpText: 'Modified 3 days ago' },
    
    // Favorites Section  
    { label: 'Project Plans', value: 'fav1', icon: '‚≠ê', divider: true },
    { label: 'Team Photos', value: 'fav2', icon: '‚≠ê' },
    { label: 'Budget 2024', value: 'fav3', icon: '‚≠ê' },
    
    // Applications Section
    { label: 'Calculator', value: 'app1', icon: 'üßÆ', divider: true },
    { label: 'Calendar', value: 'app2', icon: 'üìÖ' },
    { label: 'Notes', value: 'app3', icon: 'üìù' },
    // ... more options
  ]}
  onListboxSelect={(value) => console.log('Selected:', value)}
>
  <Button>Application Launcher</Button>
</Popover>
```

### Multiple Selection

<Canvas of={PopoverStories.WithMultipleSelection} />

```jsx
<Popover
  useListbox
  listboxMultiple
  listboxSelectedValue={['1', '3']}
  listboxOptions={[
    { label: 'Option 1', value: '1' },
    { label: 'Option 2', value: '2' },
    { label: 'Option 3', value: '3' },
    { label: 'Option 4', value: '4' },
    { label: 'Option 5', value: '5' },
  ]}
  onListboxMultiSelect={(values) => console.log('Selected values:', values)}
>
  <Button>Multi-Select</Button>
</Popover>
```

## Margin Customization

You can customize the spacing inside the popover using the `margin` prop.

<Canvas of={PopoverStories.CustomMargins} />

```jsx
// No margin
<Popover
  content="No margin"
  margin="none"
>
  <Button>No Margin</Button>
</Popover>

// Predefined margins
<Popover
  content="Small margin"
  margin="small"
>
  <Button>Small</Button>
</Popover>

<Popover
  content="Medium margin (default)"
  margin="medium"
>
  <Button>Medium</Button>
</Popover>

<Popover
  content="Large margin"
  margin="large"
>
  <Button>Large</Button>
</Popover>

// Custom pixel value
<Popover
  content="Custom 20px margin"
  margin={20}
>
  <Button>Custom (20px)</Button>
</Popover>
```

### Listbox with Custom Margins

<Canvas of={PopoverStories.ListboxWithCustomMargins} />

```jsx
<Popover
  useListbox
  margin="none"
  listboxOptions={[
    { label: 'Compact Option 1', value: '1' },
    { label: 'Compact Option 2', value: '2' },
    { label: 'Compact Option 3', value: '3' },
  ]}
  onListboxSelect={(value) => console.log('Selected:', value)}
>
  <Button>No Margin Listbox</Button>
</Popover>
```

## Listbox Item Padding Customization

You can customize the padding of individual listbox items using the `listboxItemPaddingVertical` and `listboxItemPaddingHorizontal` props.

<Canvas of={PopoverStories.ListboxWithCustomPadding} />

```jsx
// Compact padding
<Popover
  useListbox
  listboxItemPaddingVertical={8}
  listboxItemPaddingHorizontal={12}
  listboxOptions={[
    { label: 'Compact Item 1', value: '1' },
    { label: 'Compact Item 2', value: '2' },
    { label: 'Compact Item 3', value: '3' },
  ]}
  onListboxSelect={(value) => console.log('Selected:', value)}
>
  <Button>Compact Padding</Button>
</Popover>

// Spacious padding
<Popover
  useListbox
  listboxItemPaddingVertical={20}
  listboxItemPaddingHorizontal={24}
  listboxShowIcons
  listboxDefaultIcon="üìÑ"
  listboxOptions={[
    { label: 'Spacious Item 1', value: '1' },
    { label: 'Spacious Item 2', value: '2' },
    { label: 'Spacious Item 3', value: '3' },
  ]}
  onListboxSelect={(value) => console.log('Selected:', value)}
>
  <Button>Spacious Padding</Button>
</Popover>

// Custom shape (narrow height, wide sides)
<Popover
  useListbox
  listboxItemPaddingVertical={4}
  listboxItemPaddingHorizontal={32}
  listboxShowIcons
  listboxOptions={[
    { label: 'Narrow Height', value: '1', icon: 'üî•' },
    { label: 'Wide Sides', value: '2', icon: '‚ö°' },
    { label: 'Custom Shape', value: '3', icon: 'üéØ' },
  ]}
  onListboxSelect={(value) => console.log('Selected:', value)}
>
  <Button>Custom Shape</Button>
</Popover>

// Scrollable list with custom padding
<Popover
  useListbox
  type="with-scrollbar"
  listboxItemPaddingVertical={16}
  listboxItemPaddingHorizontal={20}
  listboxMaxItems={5}
  listboxShowIcons
  listboxOptions={Array.from({ length: 12 }, (_, i) => ({
    label: `Padded Option ${i + 1}`,
    value: `option-${i + 1}`,
    icon: i % 3 === 0 ? 'üìÅ' : i % 3 === 1 ? 'üìÑ' : 'üñºÔ∏è',
    helpText: i % 4 === 0 ? `Help text for option ${i + 1}` : undefined,
  }))}
  onListboxSelect={(value) => console.log('Selected:', value)}
>
  <Button>Scrollable Custom Padding</Button>
</Popover>
```

## Controlled Mode

You can control the open state of the popover using the `open` and `onOpenChange` props.

```jsx
import { useState } from 'react';

function ControlledPopover() {
  const [open, setOpen] = useState(false);
  
  return (
    <div>
      <Button onClick={() => setOpen(!open)}>
        {open ? 'Close Popover' : 'Open Popover'}
      </Button>
      
      <Popover
        content="This is a controlled popover"
        open={open}
        onOpenChange={setOpen}
      >
        <Button>Trigger</Button>
      </Popover>
    </div>
  );
}
```

## Use Cases

### Tooltips

```jsx
<Popover
  content="This is additional information about the action"
  side="top"
  showArrow={true}
>
  <Button>Hover for Info</Button>
</Popover>
```

### Dropdown Menus

```jsx
// Traditional content approach
<Popover
  content={
    <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
      <button style={{ padding: '8px', textAlign: 'left' }}>Edit</button>
      <button style={{ padding: '8px', textAlign: 'left' }}>Duplicate</button>
      <button style={{ padding: '8px', textAlign: 'left' }}>Delete</button>
    </div>
  }
>
  <Button>Menu</Button>
</Popover>

// Using listbox for better accessibility and features
<Popover
  useListbox
  listboxShowIcons
  listboxOptions={[
    { label: 'Edit', value: 'edit', icon: '‚úèÔ∏è' },
    { label: 'Duplicate', value: 'duplicate', icon: 'üìã' },
    { label: 'Delete', value: 'delete', icon: 'üóëÔ∏è' },
  ]}
  onListboxSelect={(value) => console.log('Action:', value)}
>
  <Button>Actions</Button>
</Popover>
```

### Information Cards

```jsx
<Popover
  content={
    <div>
      <h4>Item Details</h4>
      <p>Status: Active</p>
      <p>Created: June 1, 2023</p>
      <p>Owner: John Doe</p>
    </div>
  }
  side="right"
>
  <Button>View Details</Button>
</Popover>
```

### Color Picker

```jsx
<Popover
  content={
    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '8px' }}>
      {['red', 'blue', 'green', 'yellow', 'purple', 'orange', 'pink', 'teal'].map(color => (
        <div
          key={color}
          style={{
            width: '24px',
            height: '24px',
            backgroundColor: color,
            borderRadius: '4px',
            cursor: 'pointer',
          }}
          onClick={() => console.log(`Selected color: ${color}`)}
        />
      ))}
    </div>
  }
>
  <Button>Pick a Color</Button>
</Popover>
```

### File Manager Dropdown

```jsx
<Popover
  useListbox
  type="with-scrollbar"
  listboxShowIcons
  listboxMaxItems={8}
  listboxOptions={[
    { label: 'New Folder', value: 'new-folder', icon: 'üìÅ' },
    { label: 'New Document', value: 'new-doc', icon: 'üìÑ', divider: true },
    { label: 'Upload Files', value: 'upload', icon: 'üì§' },
    { label: 'Download Selected', value: 'download', icon: 'üì•', divider: true },
    { label: 'Copy', value: 'copy', icon: 'üìã' },
    { label: 'Cut', value: 'cut', icon: '‚úÇÔ∏è' },
    { label: 'Paste', value: 'paste', icon: 'üìå', divider: true },
    { label: 'Properties', value: 'properties', icon: '‚ÑπÔ∏è' },
  ]}
  onListboxSelect={(value) => console.log('File action:', value)}
>
  <Button>File Options</Button>
</Popover>
```

### User Profile Menu

```jsx
<Popover
  useListbox
  listboxShowIcons
  listboxOptions={[
    { label: 'John Doe', value: 'profile', icon: 'üë§', helpText: 'john.doe@company.com' },
    { label: 'Account Settings', value: 'settings', icon: '‚öôÔ∏è', divider: true },
    { label: 'Billing', value: 'billing', icon: 'üí≥' },
    { label: 'Help & Support', value: 'help', icon: '‚ùì', divider: true },
    { label: 'Sign Out', value: 'signout', icon: 'üö™' },
  ]}
  onListboxSelect={(value) => console.log('Profile action:', value)}
  side="bottom"
  align="end"
>
  <Button>Profile</Button>
</Popover>
```

### Language Selector

```jsx
<Popover
  useListbox
  type="with-scrollbar"
  listboxMaxItems={6}
  listboxSelectedValue="en"
  listboxOptions={[
    { label: 'English', value: 'en', icon: 'üá∫üá∏' },
    { label: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©', value: 'ar', icon: 'üá∏üá¶' },
    { label: 'Fran√ßais', value: 'fr', icon: 'üá´üá∑' },
    { label: 'Espa√±ol', value: 'es', icon: 'üá™üá∏' },
    { label: 'Deutsch', value: 'de', icon: 'üá©üá™' },
    { label: '‰∏≠Êñá', value: 'zh', icon: 'üá®üá≥' },
    { label: 'Êó•Êú¨Ë™û', value: 'ja', icon: 'üáØüáµ' },
    { label: 'ÌïúÍµ≠Ïñ¥', value: 'ko', icon: 'üá∞üá∑' },
  ]}
  onListboxSelect={(value) => console.log('Language:', value)}
>
  <Button>Language</Button>
</Popover>
```

## Internationalization

The Popover component properly handles Right-to-Left (RTL) languages by:

1. Adjusting the layout and positioning for RTL text flow
2. Applying appropriate line height for Arabic text
3. Supporting RTL content alignment

```jsx
<div dir="rtl">
  <Popover
    content="ŸÖÿ≠ÿ™ŸàŸâ ŸÖŸÜÿ®ÿ´ŸÇ ÿ®ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ©"
    side="bottom"
    align="start"
  >
    <Button>ÿßŸÅÿ™ÿ≠ ÿßŸÑŸÖŸÜÿ®ÿ´ŸÇÿ©</Button>
  </Popover>
</div>
```

## Accessibility

The Popover component follows accessibility best practices:

- Built on Radix UI's Popover primitive for robust accessibility
- Properly manages focus when opened and closed
- Uses appropriate ARIA attributes for screen readers
- Supports keyboard navigation with Tab and Escape keys
- Ensures sufficient color contrast
- Properly positions content to avoid clipping and ensure visibility
- Handles animations with respect for reduced motion preferences

## Implementation Details

### CSS Variables

The Popover component uses the following token CSS variables:

| Variable | Purpose |
|----------|---------|
| `--t-border-radius-300` | Border radius for the popover |
| `--t-space-300` | Padding inside the popover |
| `--t-color-surface-primary` | Background color |
| `--t-shadow-popover` | Shadow for depth and elevation |
| `--t-width-350` | Maximum width constraint |
| `--t-height-350` | Maximum height for scrollable popovers |
| `--t-z-index-popover` | Z-index for proper stacking |
| `--t-color-border-subtle` | Border color |
| `--t-color-fill-primary` | Arrow fill color |
| `--t-line-height-arabic` | Line height for Arabic text |
| `--t-line-height-english` | Line height for English text |

### Architecture

The Popover component is built on Radix UI's Popover primitive, which provides:

1. Focus management
2. Proper positioning
3. Collision detection
4. Keyboard navigation
5. Animation support

The Tagaddod implementation extends this with:

1. Design system integration with tokens
2. RTL language support
3. Scrollable content option
4. Animation customization
5. Simplified API for common cases

### Browser Support

The Popover component is compatible with all modern browsers and includes RTL language support. The animation performance is optimized using CSS properties like `will-change` and `transform-origin`.
