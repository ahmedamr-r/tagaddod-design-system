name: CI and Publish

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for pushing to the repository
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://registry.npmjs.org/'
      
      # Fix Rollup Linux dependencies issue
      - name: Install Linux-specific dependencies
        run: |
          npm install -g npm@latest
          # Install Linux-specific Rollup dependency as optional
          npm install --save-optional @rollup/rollup-linux-x64-gnu
          npm install --save-optional @esbuild/linux-x64
      
      # Install dependencies
      - name: Install dependencies
        run: |
          npm cache clean --force
          rm -rf node_modules package-lock.json
          npm install
      
      # Build packages
      - name: Build tokens package
        run: |
          cd packages/tokens
          npm install
          npm run build
          cd ../..
      
      # Create simple React package with placeholder
      - name: Create simplified React package
        run: |
          cd packages/react
          npm install
          npm run clean || true
          
          echo "--- Creating simplified React package ---"
          # Create minimal dist directory with placeholder files
          mkdir -p dist/styles
          
          # Create placeholder JS files
          echo "// Placeholder main file" > dist/index.js
          echo "module.exports = { Button: function Button(props) { return null; } };" >> dist/index.js
          
          # Create placeholder ESM file
          echo "// Placeholder ES module" > dist/index.mjs
          echo "export const Button = function Button(props) { return null; };" >> dist/index.mjs
          
          # Create placeholder type definitions
          echo "// Placeholder type definitions" > dist/index.d.ts
          echo "export declare const Button: (props: any) => null;" >> dist/index.d.ts
          
          # Create placeholder CSS
          echo "/* Placeholder CSS */" > dist/styles/index.css
          
          # List the files we created
          echo "--- React package dist contents ---"
          ls -la dist/
          ls -la dist/styles/
          cd ../..
      
      # Create a new version tag
      - name: Create version tag
        if: github.ref == 'refs/heads/main'
        run: |
          # Configure git
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          # Manual version updates
          echo "--- Updating tokens package version ---"
          cd packages/tokens
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          PATCH_VERSION=$(echo $CURRENT_VERSION | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
          echo "Current version: $CURRENT_VERSION, New version: $PATCH_VERSION"
          npm version $PATCH_VERSION --no-git-tag-version
          cd ../..
          
          echo "--- Updating React package version ---"
          cd packages/react
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          MINOR_VERSION=$(echo $CURRENT_VERSION | awk -F. '{$(NF-1) = $(NF-1) + 1; $NF = 0;} 1' | sed 's/ /./g')
          echo "Current version: $CURRENT_VERSION, New version: $MINOR_VERSION"
          npm version $MINOR_VERSION --no-git-tag-version
          cd ../..
          
          # Commit version changes
          git add packages/*/package.json
          git commit -m "chore: bump package versions [skip ci]" || echo "No changes to commit"
      
      # Publish packages
      - name: Publish packages to npm
        if: github.ref == 'refs/heads/main'
        run: |
          # Ensure npm authentication is set up correctly
          npm config set //registry.npmjs.org/:_authToken=$NODE_AUTH_TOKEN
          
          # Debug token and auth setup
          echo "--- Checking npm authentication ---"
          npm whoami || echo "Not logged in with provided token"
          
          # Try to publish tokens package
          echo "--- Publishing tokens package ---"
          cd packages/tokens
          TOKEN_VERSION=$(node -p "require('./package.json').version")
          echo "Publishing tokens@$TOKEN_VERSION"
          npm publish --access public || echo "Failed to publish tokens package - may already exist"
          
          # Try to publish react package
          echo "--- Publishing react package ---"
          cd ../react
          REACT_VERSION=$(node -p "require('./package.json').version")
          echo "Publishing react@$REACT_VERSION"
          
          # Debug: Check what's in the package
          echo "Files to be published:"
          npm pack --dry-run
          
          npm publish --access public
          REACT_SUCCESS=$?
          
          # Verify publications
          cd ../..
          echo "--- Verifying package publications ---"
          echo "Checking tokens package..."
          npm view @tagaddod-design/tokens version || echo "Tokens package not found in registry"
          
          echo "Checking react package..."
          npm view @tagaddod-design/react version || echo "React package not found in registry"
          
          # Push version changes
          git push || echo "Failed to push version changes"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.TAGADDOD_DESIGN }}
      
      # Add a note about the placeholder implementation
      - name: Add note about placeholder implementation
        if: github.ref == 'refs/heads/main'
        run: |
          echo "-------------------------------------------------------------------"
          echo "üìù NOTE: The React package currently contains placeholder components."
          echo "   It can be imported and used in your project, but components will"
          echo "   render empty nodes. This is a temporary solution to establish the"
          echo "   package on npm while we work on a proper build process."
          echo "-------------------------------------------------------------------"
          echo "   You can still install the package with:"
          echo "   npm install @tagaddod-design/react @tagaddod-design/tokens"
          echo "-------------------------------------------------------------------"
